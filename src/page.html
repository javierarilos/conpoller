<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Feedbacker</title>
    <style media="screen" type="text/css">
        .response-btn {
            box-shadow:inset 0px 1px 0px 0px #ffffff;
            background:linear-gradient(to bottom, #f9f9f9 5%, #e9e9e9 100%);
            background-color:#f9f9f9;
            border-radius:6px;
            border:1px solid #dcdcdc;
            display:inline-block;
            cursor:pointer;
            color:#333333;
            font-family:monospace;
            font-size:14px;
            padding:6px 24px;
            text-decoration:none;
            text-shadow:0px 1px 0px #ffffff;
        }

        .circle {
          border-radius: 50%;
	        width: 20px;
	        height: 20px;
          background-color: orange
        }

        #poll_canvas {
            background-color:#f9f9f9;
            border:1px solid #c3c3c3;

        }
        .response-btn:active {
            position:relative;
            top:1px;
        }
        .poll_question {
            font-family:monospace;
            font-size:18px;
            font-weight:bold;
            padding:6px 24px;
            text-decoration:none;
        }
        .response_buttons {
            float: left;
        }

        @media only screen and (max-width: 700px) {
            .poll_question {
                font-size:18px;
            }
            .response-btn {
                font-size:16px;
            }
        }

    </style>

</head>
<body id="body">
<br/>
<span id="poll_question" class="poll_question">Nice Poll</span>
<br/>

<div id="connection_status" class="circle"></div>
<br/>

<!--<span id="response_buttons"></span>-->
<form id="response_buttons"></form>
<br/>
<canvas id="poll_canvas" height="225">
    Your browser does not support the HTML5 canvas tag.
</canvas>
<br/>
<span name="<!-- session-id -->" id="session-id">
    <!-- presenter-sect -->

</span>
<br/>

<script>
    var currentPoll = null;
    var responseLabels = [];

    function getCurrentPollId(){
        return currentPoll && currentPoll.id;
    }

    var ctx = poll_canvas.getContext("2d");
    var barColors = ["#FF0000", "#00FF00", "#0000FF", "#FF00FF"];
    var sessionId = document.getElementById('session-id').getAttribute("name");
    var lastMessageTs = 0;

    function initCanvas() {
        ctx.canvas.width = window.innerWidth - (window.innerWidth * 0.01);
    }

    console.log('My user id is:', sessionId);//TODO: properly storing userId

    function disableElementsOf(parent) {

      var elements = parent.elements;
      for (var i = 0, len = elements.length; i < len; ++i) {
          elements[i].readOnly = true;
          elements[i].disabled = true;
      }
    }

    var responseButtonPressed = function(id, parent) {
      submitPollResponse(id);
      disableElementsOf(parent);
    }

    var submitPollResponse = function (id) {
        //curl -X POST --data '{"question": 0, "response": 2}' http://localhost:8125/response
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("POST","response",true);
        xmlhttp.setRequestHeader("Content-type","application/json");
        xmlhttp.send('{"question": '+getCurrentPollId()+', "response": '+id+'}');
    };

    var submitPagingRequest = function (type) {//type: next || prev
        //curl -X POST --data '{"userId": "lksdjflsdkjf"}' http://localhost:8125/prev -v
        //curl -X POST --data '{"userId": "lksdjflsdkjf"}' http://localhost:8125/next -v
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("POST",type,true);
        xmlhttp.setRequestHeader("Content-type","application/json");
        xmlhttp.send('{"sessionId": "'+sessionId+'"}');
    };

    function getCurrentButtonsFont() {
        var but = document.getElementsByClassName("response-btn")[0];
        var styleSize = but.style.fontSize;
        //get computedStyle
        var style = window.getComputedStyle(but, null).getPropertyValue('font-size');
        var computedFontSize = parseFloat(style);

        return styleSize || computedFontSize || 14;
    }

    function paintQuestionResult(i, question, count) {
        //ctx.fillStyle = "#FFFFFF";

        ctx.fillStyle = barColors[i];
        ctx.fillRect(5, 5 + (55 * (i + 0)), 25 * count, 50);
        var fontSize = getCurrentButtonsFont();
        ctx.font = fontSize + "px Courier, monospace";
        ctx.fillStyle = "#000000";
        ctx.fillText(question + " ["+count+"]", 10, 5 + (55 * (i + 0)) + 25);
    }

    function updatePoll(poll) {
        if (getCurrentPollId() !== poll.id) {
            responseLabels = [];
            initializeResponseButtons(poll);
            currentPoll = poll;
            poll_question.innerHTML = poll.title;
        }
        updatePollResults(poll);
    }

    function updatePollResults(pollResults){
      updatePollResultsCanvas(pollResults);
      updatePollResultsButtons(pollResults);
    }

    function updatePollResultsButtons(pollResults){
      pollResults.responses.forEach(function(question, index){
        var currLabel = responseLabels[index];
        currLabel.innerHTML = question.text + " [" +  question.count + "]";
      });
    }

    function updatePollResultsCanvas(pollResults){
        var responses = pollResults.responses;
        ctx.fillStyle = "#f9f9f9";
        ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        for(var i = 0; i < responses.length; i++) {
            var currResult = responses[i];
            console.log('updating result: ', currResult.id, currResult.text, currResult.count);
            paintQuestionResult(currResult.id, currResult.text, currResult.count);
        }
    }

    function createResponseButton(responseButtonsParent, id, text) {
        var element = document.createElement("input");
        //Assign different attributes to the element.
        element.type = 'radio'; //previously was:'button'
        element.id = 'response-'+id;
        element.className = 'response-btn';
        element.name = 'response-'+id;
        element.onclick = responseButtonPressed.bind(element, id, responseButtonsParent);
        element.value = text;

        var label = document.createElement("label");
        label.id = 'label-' + element.id;
        label.for = element.id;
        label.innerHTML = text;

        //Append the element in page (in span).
        responseButtonsParent.appendChild(element);
        responseButtonsParent.appendChild(label);
        return label;
    }

    function initializeResponseButtons(pollResults) {
        while (response_buttons.firstChild) { //remove all existing buttons.
            response_buttons.removeChild(response_buttons.firstChild);
        }
        pollResults.responses.forEach(function(question){
            var label = createResponseButton(response_buttons, question.id, question.text);
            responseLabels.push(label);
        });
    }

    function processServerSentEvent(event){
        console.log(">>>>>>>", event.data, event.event, arguments);
        lastMessageTs = Date.now();
        var parsedEvent = JSON.parse(event.data);
        updatePoll(parsedEvent);
    }

    initCanvas();

    var source = new EventSource('/poll?tout=10000');
    source.addEventListener('message', processServerSentEvent, false);

    window.onresize = function () {
        initCanvas();
        updatePollResults(currentPoll);
    }

    source.addEventListener('open', function(e) {
        console.log('Connection was opened.', e.event);
    }, false);

    source.addEventListener('error', function(e) {
        if (e.readyState == EventSource.CLOSED) {
            console.log('Connection was closed.',e.event, e);
            return;
        }
        console.log('Other error', e);
        source.close();
    }, false);

</script>
</body>
</html>
